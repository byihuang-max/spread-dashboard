<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è€å¿ƒèµ„æœ¬æŒç­¹æˆæœ¬</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background: #0a0e17;
    color: #c8d6e5;
    padding: 16px;
}
h1 {
    text-align: center;
    font-size: 20px;
    color: #f5f6fa;
    margin-bottom: 4px;
}
.subtitle {
    text-align: center;
    font-size: 12px;
    color: #636e72;
    margin-bottom: 16px;
}
/* â•â•â• æ¦‚è§ˆå¡ç‰‡ â•â•â• */
.cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}
@media (max-width: 900px) { .cards { grid-template-columns: repeat(2, 1fr); } }
.card {
    background: #141a2a;
    border: 1px solid #1e2d4a;
    border-radius: 8px;
    padding: 12px 14px;
    cursor: pointer;
    transition: all 0.2s;
}
.card:hover { border-color: #3498db; }
.card.active { border-color: #f39c12; background: #1a2236; }
.card .idx-name {
    font-size: 14px;
    font-weight: 600;
    color: #dfe6e9;
    margin-bottom: 6px;
}
.card .cum {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 2px;
}
.card .meta {
    font-size: 11px;
    color: #636e72;
    line-height: 1.6;
}
.card .meta span { margin-right: 10px; }
.up { color: #e74c3c; }
.down { color: #2ecc71; }
.flat { color: #95a5a6; }

/* â•â•â• å›¾è¡¨åŒº â•â•â• */
.chart-section {
    background: #141a2a;
    border: 1px solid #1e2d4a;
    border-radius: 8px;
    padding: 16px;
}
.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.chart-title {
    font-size: 16px;
    font-weight: 600;
    color: #f5f6fa;
}
.range-btns button {
    background: #1e2d4a;
    color: #b2bec3;
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 4px;
}
.range-btns button.active { background: #f39c12; color: #0a0e17; }
.chart-container { position: relative; height: 320px; margin-bottom: 16px; }
.bar-container { position: relative; height: 180px; }
.no-data {
    text-align: center;
    color: #636e72;
    padding: 60px 0;
    font-size: 14px;
}
</style>
</head>
<body>

<h1>ğŸ›ï¸ è€å¿ƒèµ„æœ¬æŒç­¹æˆæœ¬</h1>
<div class="subtitle" id="updated"></div>

<div class="cards" id="cards"></div>

<div class="chart-section">
    <div class="chart-header">
        <div class="chart-title" id="chartTitle">é€‰æ‹©ä¸€ä¸ªæŒ‡æ•°æŸ¥çœ‹è¯¦æƒ…</div>
        <div class="range-btns" id="rangeBtns">
            <button data-range="90">3M</button>
            <button data-range="180">6M</button>
            <button data-range="365">1Y</button>
            <button data-range="0" class="active">ALL</button>
        </div>
    </div>
    <div class="chart-container"><canvas id="mainChart"></canvas></div>
    <div class="bar-container"><canvas id="barChart"></canvas></div>
</div>

<script>
let DATA = null;
let currentIndex = null;
let currentRange = 0;
let mainChart = null;
let barChart = null;

async function loadData() {
    try {
        const resp = await fetch('patient_capital.json?t=' + Date.now());
        DATA = await resp.json();
        document.getElementById('updated').textContent = 'æ›´æ–°: ' + DATA.updated;
        renderCards();
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        const first = Object.keys(DATA.indices)[0];
        if (first) selectIndex(first);
    } catch (e) {
        document.getElementById('cards').innerHTML = '<div class="no-data">åŠ è½½æ•°æ®å¤±è´¥: ' + e.message + '</div>';
    }
}

function renderCards() {
    const el = document.getElementById('cards');
    el.innerHTML = '';
    for (const [name, info] of Object.entries(DATA.indices)) {
        const L = info.latest;
        if (!L) continue;
        const pnlClass = L.pnl > 0 ? 'up' : L.pnl < 0 ? 'down' : 'flat';
        const pnlSign = L.pnl > 0 ? '+' : '';
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.index = name;
        card.innerHTML = `
            <div class="idx-name">${name}</div>
            <div class="cum ${pnlClass}">${L.cum.toFixed(1)} äº¿</div>
            <div class="meta">
                <span>æˆæœ¬ ${L.cost.toFixed(3)}</span>
                <span>ç°ä»· ${L.close.toFixed(3)}</span>
                <span class="${pnlClass}">${pnlSign}${L.pnl.toFixed(1)}%</span>
            </div>
        `;
        card.onclick = () => selectIndex(name);
        el.appendChild(card);
    }
}

function selectIndex(name) {
    currentIndex = name;
    document.querySelectorAll('.card').forEach(c => {
        c.classList.toggle('active', c.dataset.index === name);
    });
    document.getElementById('chartTitle').textContent = name + ' - è€å¿ƒèµ„æœ¬æŒä»“ä¼°ç®—';
    renderCharts();
}

function filterByRange(daily) {
    if (currentRange === 0) return daily;
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - currentRange);
    const cutStr = cutoff.toISOString().slice(0, 10).replace(/-/g, '');
    return daily.filter(d => d.date >= cutStr);
}

function renderCharts() {
    if (!DATA || !currentIndex) return;
    const info = DATA.indices[currentIndex];
    if (!info || !info.daily || info.daily.length === 0) return;

    const daily = filterByRange(info.daily);
    const labels = daily.map(d => {
        const s = d.date;
        return s.slice(0,4) + '-' + s.slice(4,6) + '-' + s.slice(6,8);
    });

    // â•â•â• ä¸»å›¾ï¼šæ”¶ç›˜ä»· + æˆæœ¬çº¿ â•â•â•
    const closePrices = daily.map(d => d.close);
    const costPrices = daily.map(d => d.cost > 0 ? d.cost : null);
    const cumPositions = daily.map(d => d.cum);

    if (mainChart) mainChart.destroy();
    mainChart = new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'æ”¶ç›˜ä»·',
                    data: closePrices,
                    borderColor: '#3498db',
                    borderWidth: 1.5,
                    pointRadius: 0,
                    tension: 0.1,
                    yAxisID: 'y',
                },
                {
                    label: 'æˆæœ¬çº¿',
                    data: costPrices,
                    borderColor: '#f39c12',
                    borderWidth: 2,
                    borderDash: [6, 3],
                    pointRadius: 0,
                    tension: 0.1,
                    yAxisID: 'y',
                },
                {
                    label: 'ç´¯è®¡æŒä»“(äº¿)',
                    data: cumPositions,
                    borderColor: 'rgba(155,89,182,0.6)',
                    backgroundColor: 'rgba(155,89,182,0.08)',
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.1,
                    yAxisID: 'y1',
                },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { labels: { color: '#b2bec3', font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        title: (items) => items[0].label,
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#636e72', maxTicksLimit: 12, font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.04)' },
                },
                y: {
                    position: 'left',
                    ticks: { color: '#3498db', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.04)' },
                    title: { display: true, text: 'ä»·æ ¼', color: '#3498db', font: { size: 10 } },
                },
                y1: {
                    position: 'right',
                    ticks: { color: '#9b59b6', font: { size: 10 } },
                    grid: { display: false },
                    title: { display: true, text: 'æŒä»“(äº¿)', color: '#9b59b6', font: { size: 10 } },
                },
            }
        }
    });

    // â•â•â• å‰¯å›¾ï¼šæ¯æ—¥å‡€ä¹°å–æŸ±çŠ¶å›¾ â•â•â•
    const netAmts = daily.map(d => d.net);
    const barColors = netAmts.map(v => v >= 0 ? 'rgba(231,76,60,0.7)' : 'rgba(46,204,113,0.7)');

    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'æ¯æ—¥å‡€é¢(äº¿)',
                data: netAmts,
                backgroundColor: barColors,
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#b2bec3', font: { size: 11 } } },
            },
            scales: {
                x: {
                    ticks: { color: '#636e72', maxTicksLimit: 12, font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.04)' },
                },
                y: {
                    ticks: { color: '#b2bec3', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.04)' },
                    title: { display: true, text: 'äº¿å…ƒ', color: '#b2bec3', font: { size: 10 } },
                },
            }
        }
    });
}

// æ—¶é—´èŒƒå›´æŒ‰é’®
document.getElementById('rangeBtns').addEventListener('click', e => {
    if (e.target.tagName !== 'BUTTON') return;
    currentRange = parseInt(e.target.dataset.range);
    document.querySelectorAll('#rangeBtns button').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    renderCharts();
});

loadData();
</script>
</body>
</html>
