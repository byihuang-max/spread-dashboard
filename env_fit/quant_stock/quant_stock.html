<!DOCTYPE html>
<html lang="zh"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å®½åŸºé‡åŒ–è‚¡ç¥¨</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,'PingFang SC','Helvetica Neue','Microsoft YaHei',sans-serif;background:#f5f6f8;color:#2d3142;padding:20px;font-size:14px}
.card{background:#fff;border-radius:12px;padding:18px;margin-bottom:16px;border:1px solid #e8eaef}
.card-title{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:7px;color:#2d3142}
.card-title .dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.header-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:0 2px}
.header-bar .date-label{font-size:13px;color:#888}
.header-bar .date-label b{color:#2d3142}
.refresh-btn{background:#fff;border:1px solid #d1d5db;border-radius:8px;padding:6px 14px;font-size:12px;font-weight:600;color:#555;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s}
.refresh-btn:hover{background:#f0f4ff;border-color:#6366f1;color:#6366f1}

/* â”€â”€ è¯Šæ–­é¢æ¿ â”€â”€ */
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.diag-hero{
  background:linear-gradient(135deg,#0c1222,#162038 50%,#1a1040 80%,#0c1222);
  border-radius:16px;padding:24px 28px;color:#e2e8f0;margin-bottom:16px;
  position:relative;overflow:hidden;animation:fadeUp .4s ease-out;
}
.diag-hero::before{content:'';position:absolute;top:-60px;right:-40px;width:220px;height:220px;background:radial-gradient(circle,rgba(99,102,241,0.1),transparent 65%);border-radius:50%}
.diag-hero::after{content:'';position:absolute;bottom:-40px;left:25%;width:160px;height:160px;background:radial-gradient(circle,rgba(16,185,129,0.07),transparent 65%);border-radius:50%}

.diag-score-ring{position:relative;width:100px;height:100px;flex-shrink:0}
.diag-score-ring svg{transform:rotate(-90deg)}
.diag-score-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900}

.factor-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px}
.factor-card{
  background:#fff;border-radius:12px;padding:14px;border:1px solid #e8eaef;
  animation:fadeUp .4s ease-out both;transition:transform .15s;
}
.factor-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.06)}
.factor-card:nth-child(1){animation-delay:.05s}
.factor-card:nth-child(2){animation-delay:.1s}
.factor-card:nth-child(3){animation-delay:.15s}
.factor-card:nth-child(4){animation-delay:.2s}
.factor-card:nth-child(5){animation-delay:.25s}
.factor-score{font-size:22px;font-weight:900;font-variant-numeric:tabular-nums}
.factor-label{font-size:11px;color:#64748b;font-weight:600;margin-bottom:4px}
.factor-grade{font-size:12px;font-weight:700;margin-top:2px}
.factor-bar{width:100%;height:4px;background:#f1f5f9;border-radius:2px;overflow:hidden;margin:8px 0}
.factor-bar-fill{height:100%;border-radius:2px;transition:width .6s ease}
.factor-sig{font-size:10px;color:#94a3b8;line-height:1.5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.narrative-box{
  background:rgba(255,255,255,0.9);backdrop-filter:blur(8px);
  border-radius:12px;border:1px solid #e8eaef;padding:16px 20px;margin-bottom:16px;
  animation:fadeUp .4s ease-out .3s both;
}
.narrative-text{font-size:13px;color:#334155;line-height:1.8}
.narrative-text .sep{color:#cbd5e1;margin:0 6px}

.neutral-box{
  background:#f8fafc;border-radius:10px;border:1px solid #e8eaef;
  padding:14px 18px;margin-bottom:16px;animation:fadeUp .4s ease-out .35s both;
}
.neutral-title{font-size:12px;font-weight:700;color:#64748b;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.neutral-row{display:flex;align-items:center;gap:16px;font-size:12px}
.neutral-metric{text-align:center}
.neutral-metric .val{font-size:18px;font-weight:800;color:#1e293b}
.neutral-metric .lab{font-size:10px;color:#94a3b8;margin-top:2px}
.neutral-divider{width:1px;height:36px;background:#e2e8f0}
.neutral-verdict{font-size:13px;font-weight:700;margin-left:auto;padding:4px 12px;border-radius:8px}
</style>
</head><body>

<div class="header-bar">
  <div class="date-label" id="dateLabel">ğŸ“Š å®½åŸºé‡åŒ–è‚¡ç¥¨ Â· åŠ è½½ä¸­...</div>
  <button class="refresh-btn" onclick="doRefresh()" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
</div>

<!-- â•â•â• è¶…é¢ç¯å¢ƒè¯Šæ–­é¢æ¿ â•â•â• -->
<div id="diag-panel"></div>

<!-- â•â•â• è¶…é¢å‡€å€¼å½’å› æ›²çº¿ â•â•â• -->
<div class="card" id="excess-card" style="display:none">
  <div class="card-title"><span class="dot" style="background:#6366f1"></span> äº§å“å‡€å€¼ Ã— è¶…é¢å½’å› </div>
  <div style="position:relative;height:380px"><canvas id="chartExcess"></canvas></div>
  <div id="excess-tooltip" style="display:none;position:absolute;z-index:99;background:rgba(15,23,42,0.95);color:#e2e8f0;border-radius:10px;padding:14px 18px;font-size:12px;line-height:1.7;pointer-events:none;max-width:360px;box-shadow:0 8px 32px rgba(0,0,0,0.25);backdrop-filter:blur(8px)"></div>
  <div style="display:flex;gap:16px;margin-top:10px;font-size:11px;color:#94a3b8;justify-content:center">
    <span>ğŸŸ£ äº§å“å‡€å€¼</span>
    <span>âšª åŸºå‡†æŒ‡æ•°</span>
    <span>ğŸŸ¡ ç´¯è®¡è¶…é¢(å³è½´)</span>
    <span>|</span>
    <span>ğŸŸ¢ è¶…é¢é¡ºé£ (å‘¨Î”>+1%)</span>
    <span>ğŸŸ¡ èµ°å¹³/å¾®å›æ’¤</span>
    <span>ğŸ”´ æ˜æ˜¾å›æ’¤ (å‘¨Î”<-1%)</span>
    <span>çº¢è‰²èƒŒæ™¯=åŸºå‡†å›æ’¤>2%</span>
  </div>
</div>

<!-- â•â•â• åŸæœ‰å›¾è¡¨ â•â•â• -->
<div class="card">
  <div class="card-title"><span class="dot" style="background:#e74c3c"></span> å…¨å¸‚åœºæˆäº¤é¢æ—¶åºï¼ˆäº¿å…ƒï¼‰</div>
  <div style="position:relative;height:280px"><canvas id="chartAmount"></canvas></div>
</div>

<div class="card">
  <div class="card-title"><span class="dot" style="background:#3498db"></span> å®½åŸºæˆäº¤é¢å å…¨Aæ¯”ä¾‹ï¼ˆ%ï¼‰</div>
  <div style="position:relative;height:320px"><canvas id="chartShare"></canvas></div>
</div>

<!-- â•â•â• é£æ ¼è¿ç§»é€Ÿåº¦å­æ¨¡å— â•â•â• -->
<div class="card" id="migration-card" style="display:none">
  <div class="card-title"><span class="dot" style="background:#8b5cf6"></span> é£æ ¼å æ¯”å˜åŒ–ç‡ï¼ˆ5æ—¥ vs 20æ—¥å‡å€¼ Î”ppï¼‰</div>
  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
    <div style="flex:1;min-width:300px;position:relative;height:220px"><canvas id="chartMigration"></canvas></div>
    <div id="migration-summary" style="flex:0 0 220px;font-size:12px;line-height:1.8;padding:8px 0"></div>
  </div>
</div>

<div class="card">
  <div class="card-title"><span class="dot" style="background:#f39c12"></span> IF/IC/IM å¹´åŒ–åŸºå·®ï¼ˆ%ï¼‰</div>
  <div style="position:relative;height:280px"><canvas id="chartBasis"></canvas></div>
</div>

<div class="card">
  <div class="card-title"><span class="dot" style="background:#9b59b6"></span> å› å­è¶…é¢æ”¶ç›Šå‡€å€¼ï¼ˆvs ä¸­è¯å…¨æŒ‡ï¼‰</div>
  <div style="position:relative;height:280px"><canvas id="chartFactor"></canvas></div>
</div>

<div class="card" style="font-size:12px;color:#999;line-height:1.8">
  <div class="card-title" style="font-size:13px;color:#666"><span class="dot" style="background:#999"></span> ğŸ“ æŒ‡æ ‡è¯´æ˜</div>
  <p><b style="color:#555">â‘  å…¨å¸‚åœºæˆäº¤é¢ï¼š</b>ä¸­è¯å…¨æŒ‡(000985.CSI)æ—¥æˆäº¤é¢ï¼Œå•ä½äº¿å…ƒï¼Œåæ˜ å¸‚åœºæ•´ä½“æµåŠ¨æ€§æ°´å¹³</p>
  <p><b style="color:#555">â‘¡ å®½åŸºå æ¯”ï¼š</b>æ²ªæ·±300/ä¸­è¯500/1000/2000/ç§‘åˆ›50+åˆ›ä¸šæ¿æŒ‡ å„è‡ªæˆäº¤é¢å ä¸­è¯å…¨æŒ‡æ¯”ä¾‹ï¼Œè§‚å¯Ÿèµ„é‡‘ä¸»æˆ˜åœºè¿ç§»</p>
  <p><b style="color:#555">â‘¢ å¹´åŒ–åŸºå·®ï¼š</b>(ä¸»åŠ›åˆçº¦æ”¶ç›˜-ç°è´§æŒ‡æ•°æ”¶ç›˜)/ç°è´§ Ã— 12 Ã— 100ï¼Œè´Ÿå€¼=è´´æ°´ï¼ˆå¯¹å†²æˆæœ¬ï¼‰ï¼Œæ­£å€¼=å‡æ°´</p>
  <p><b style="color:#555">â‘£ å› å­è¶…é¢ï¼š</b>å„å› å­æŒ‡æ•°ç›¸å¯¹ä¸­è¯å…¨æŒ‡çš„æ—¥åº¦è¶…é¢æ”¶ç›Šç´¯è®¡å‡€å€¼ã€‚æˆé•¿=å›½è¯æˆé•¿(399370)ï¼Œçº¢åˆ©=ä¸­è¯çº¢åˆ©(000922)ï¼Œå°ç›˜=ä¸­è¯2000(932000)</p>
</div>

<script>
(function(){
// â•â•â• è¯Šæ–­é¢æ¿ â•â•â•
var diagBase = location.href.replace(/[^/]*$/,'');
if(!diagBase.endsWith('/')) diagBase+='/';

fetch(diagBase+'quant_env_diag.json?t='+Date.now()).then(function(r){return r.json()}).then(function(D){
  var sc = D.env_score;
  var scoreCol = sc>=75?'#10b981':sc>=55?'#f59e0b':sc>=40?'#f97316':'#ef4444';
  var dashOff = 251*(1-sc/100); // 2*pi*40

  var html = '';

  // â”€â”€ Hero â”€â”€
  html += '<div class="diag-hero">';
  html += '<div style="display:flex;align-items:center;gap:24px;position:relative;z-index:1;flex-wrap:wrap">';

  // Ring
  html += '<div class="diag-score-ring">';
  html += '<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="7"/>';
  html += '<circle cx="50" cy="50" r="40" fill="none" stroke="'+scoreCol+'" stroke-width="7" stroke-linecap="round" stroke-dasharray="251" stroke-dashoffset="'+dashOff+'" style="filter:drop-shadow(0 0 8px '+scoreCol+'60);transition:stroke-dashoffset .8s ease"/>';
  html += '</svg>';
  html += '<div class="diag-score-num" style="color:'+scoreCol+'">'+sc+'</div>';
  html += '</div>';

  // Text
  html += '<div>';
  html += '<div style="font-size:10px;color:#4b5578;letter-spacing:1.5px;text-transform:uppercase;font-weight:800;margin-bottom:4px">è¶…é¢ç¯å¢ƒè¯Šæ–­</div>';
  html += '<div style="font-size:20px;font-weight:800;color:'+scoreCol+'">'+D.env_emoji+' '+D.env_grade+'</div>';
  if(D.alpha_environment){
    html += '<div style="font-size:11px;color:#64748b;margin-top:4px">Alphaç¯å¢ƒ: '+D.alpha_environment.label+'ï¼ˆ'+D.alpha_environment.score+'åˆ†ï¼‰</div>';
  }
  html += '</div>';

  // Update time
  html += '<div style="margin-left:auto;text-align:right">';
  html += '<div style="font-size:10px;color:#4b5578">æ›´æ–°: '+D.update_time+'</div>';
  html += '</div>';

  html += '</div></div>';

  // â”€â”€ Factor cards â”€â”€
  html += '<div class="factor-grid">';
  var fOrder = ['æµåŠ¨æ€§','ç¦»æ•£åº¦','é£æ ¼é›†ä¸­åº¦','å¸‚åœºé¢„æœŸ','å¾®è§‚ç»“æ„'];
  var fIcons = {'æµåŠ¨æ€§':'ğŸ’§','ç¦»æ•£åº¦':'ğŸ“Š','é£æ ¼é›†ä¸­åº¦':'ğŸ¯','å¸‚åœºé¢„æœŸ':'ğŸ”®','å¾®è§‚ç»“æ„':'ğŸ”¬'};
  fOrder.forEach(function(name){
    var f = D.factors[name]||{};
    var s = f.score||0;
    var col = s>=70?'#10b981':s>=45?'#f59e0b':'#ef4444';
    var bgCol = s>=70?'#f0fdf4':s>=45?'#fffbeb':'#fef2f2';
    var borderCol = s>=70?'#bbf7d0':s>=45?'#fde68a':'#fecaca';

    html += '<div class="factor-card" style="border-color:'+borderCol+';background:'+bgCol+'">';
    html += '<div class="factor-label">'+fIcons[name]+' '+name+'</div>';
    html += '<div style="display:flex;align-items:baseline;justify-content:space-between">';
    html += '<div class="factor-score" style="color:'+col+'">'+s+'</div>';
    html += '<div class="factor-grade" style="color:'+col+'">'+f.emoji+' '+f.grade+'</div>';
    html += '</div>';
    html += '<div class="factor-bar"><div class="factor-bar-fill" style="width:'+s+'%;background:'+col+'"></div></div>';

    // Show first 2 signals
    var sigs = (f.signals||[]).slice(0,2);
    sigs.forEach(function(sig){
      html += '<div class="factor-sig">'+sig+'</div>';
    });

    html += '</div>';
  });
  html += '</div>';

  // â”€â”€ Narrative â”€â”€
  html += '<div class="narrative-box">';
  html += '<div style="font-size:11px;font-weight:700;color:#64748b;margin-bottom:8px;display:flex;align-items:center;gap:6px">ğŸ§  è¯Šæ–­é€»è¾‘</div>';
  var parts = D.narrative.split(' â†’ ');
  html += '<div class="narrative-text">';
  html += parts.map(function(p,i){
    var icon = i===0?'ğŸ’§':i===1?'ğŸ“Š':i===2?'ğŸ”®':'ğŸ”¬';
    return '<span>'+icon+' '+p+'</span>';
  }).join('<span class="sep">â†’</span>');
  html += '</div></div>';

  // â”€â”€ Neutral aux â”€â”€
  var N = D.neutral_aux;
  if(N && N.available){
    html += '<div class="neutral-box">';
    html += '<div class="neutral-title">ğŸ“ ä¸­æ€§ç­–ç•¥å‚è€ƒ</div>';
    html += '<div class="neutral-row">';

    html += '<div class="neutral-metric"><div class="val">'+N.excess_annual_pct.toFixed(1)+'%</div><div class="lab">è¶…é¢å¹´åŒ–</div></div>';
    html += '<div class="neutral-divider"></div>';
    html += '<div class="neutral-metric"><div class="val">'+N.basis_annual_cost_pct.toFixed(1)+'%</div><div class="lab">åŸºå·®æˆæœ¬</div></div>';
    html += '<div class="neutral-divider"></div>';
    html += '<div class="neutral-metric"><div class="val">'+(N.ratio==='inf'?'âˆ':N.ratio.toFixed(1))+'x</div><div class="lab">è¶…é¢/åŸºå·®</div></div>';
    html += '<div class="neutral-divider"></div>';

    var vCol = N.verdict_emoji==='âœ…'?'#dcfce7;color:#166534':N.verdict_emoji==='âŒ'?'#fee2e2;color:#991b1b':'#fef9c3;color:#854d0e';
    html += '<div class="neutral-verdict" style="background:'+vCol+'">'+N.verdict_emoji+' '+N.verdict+'</div>';

    html += '</div></div>';
  }

  document.getElementById('diag-panel').innerHTML = html;

  // â•â•â• é£æ ¼è¿ç§»å­å›¾è¡¨ â•â•â•
  var conc = D.factors['é£æ ¼é›†ä¸­åº¦']||{};
  var mig = conc.migration;
  if(mig && mig.deltas && Object.keys(mig.deltas).length>0){
    document.getElementById('migration-card').style.display='';

    // æŸ±çŠ¶å›¾ï¼šå„é£æ ¼Î”pp
    var migLabels = Object.keys(mig.deltas);
    var migVals = migLabels.map(function(k){return mig.deltas[k]});
    var migColors = migVals.map(function(v){return v>2?'#ef4444':v>0?'#f59e0b':v>-2?'#3b82f6':'#ef4444'});

    new Chart(document.getElementById('chartMigration'),{
      type:'bar',
      data:{labels:migLabels,datasets:[{
        label:'å æ¯”å˜åŒ–(pp)',data:migVals,
        backgroundColor:migColors,borderRadius:6,barPercentage:0.6
      }]},
      options:{
        responsive:true,maintainAspectRatio:false,
        indexAxis:'y',
        plugins:{legend:{display:false}},
        scales:{
          x:{grid:{color:'#f1f5f9'},ticks:{callback:function(v){return (v>0?'+':'')+v+'pp'},font:{size:11}}},
          y:{grid:{display:false},ticks:{font:{size:11,weight:600}}}
        }
      }
    });

    // å³ä¾§æ‘˜è¦
    var sumHtml = '';
    var intCol = mig.intensity_score>=60?'#ef4444':mig.intensity_score>=30?'#f59e0b':'#10b981';
    sumHtml += '<div style="margin-bottom:10px"><span style="font-weight:700;color:#334155">è¿ç§»å¼ºåº¦</span>';
    sumHtml += ' <span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;background:'+intCol+'20;color:'+intCol+'">'+mig.intensity+'</span></div>';

    if(mig.max_mover){
      var dir = mig.max_delta_signed>0?'â†‘å¸å…¥':'â†“æµå‡º';
      sumHtml += '<div style="color:#64748b">æœ€å¤§å˜åŒ–: <b style="color:#1e293b">'+mig.max_mover+'</b></div>';
      sumHtml += '<div style="color:#64748b">'+dir+' <b style="color:#1e293b">'+Math.abs(mig.max_delta_signed).toFixed(1)+'pp</b> (5æ—¥vs20æ—¥)</div>';
    }

    sumHtml += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e8eaef;color:#94a3b8;font-size:10px;line-height:1.6">';
    sumHtml += 'âš ï¸ å•ä¸€é£æ ¼5æ—¥å˜åŒ–>5ppä¸ºå‰§çƒˆè¿ç§»<br>é‡åŒ–æŒä»“åˆ†æ•£ï¼Œå‰§çƒˆè¿ç§»=è¶…é¢é£é™©';
    sumHtml += '</div>';

    document.getElementById('migration-summary').innerHTML = sumHtml;
  }

// â•â•â• è¶…é¢å‡€å€¼å½’å› æ›²çº¿ â•â•â•
Promise.all([
  fetch(diagBase+'excess_attribution.json?t='+Date.now()).then(function(r){return r.json()}),
  fetch('../../size_spread/fund_nav/fund_nav_quant-stock.json?t='+Date.now()).then(function(r){return r.json()}).catch(function(){return null})
]).then(function(results){
  var EA=results[0];
  var NAV=results[1];
  if(!EA.points||!EA.points.length) return;
  document.getElementById('excess-card').style.display='';

  var pts = EA.points;
  var labels = pts.map(function(p){return p.date});
  var exData = pts.map(function(p){return (p.excess*100).toFixed(2)*1});

  // ä»fund_nav JSONæå–å‡€å€¼æ•°æ®
  var navF=NAV?(NAV.fund||(NAV.funds||[])[0]):null;
  var fundNav = navF?navF.chart.fund_nav:null;
  var indexNav = navF?navF.chart.index_nav:null;
  var fundLabel = navF?(navF.show_name!==false?navF.name:'ä»£è¡¨äº§å“'):'äº§å“';
  var benchLabel = navF?navF.benchmark_name:'åŸºå‡†';

  // å›æ’¤æ ‡è®°: åŸºå‡†å›æ’¤>2%åŒºåŸŸ
  var navDD = [];
  if(indexNav){
    var peak=indexNav[0]||1;
    for(var i=0;i<indexNav.length;i++){
      if(indexNav[i]>peak) peak=indexNav[i];
      navDD.push((indexNav[i]-peak)/peak < -0.02 ? 1 : 0);
    }
  }

  var zoneColors = {bad:'rgba(239,68,68,0.12)',weak:'rgba(251,191,36,0.10)',good:'rgba(16,185,129,0.06)',neutral:'transparent'};

  var bgPlugin = {
    id:'zoneBg',
    beforeDraw:function(chart){
      var ctx=chart.ctx;
      var xScale=chart.scales.x;
      var yScale=chart.scales.y;
      var top=yScale.top;
      var bottom=yScale.bottom;
      pts.forEach(function(p,i){
        if(p.zone==='neutral') return;
        var x0 = i>0 ? (xScale.getPixelForValue(i-1)+xScale.getPixelForValue(i))/2 : xScale.getPixelForValue(i)-((xScale.getPixelForValue(1)-xScale.getPixelForValue(0))/2);
        var x1 = i<pts.length-1 ? (xScale.getPixelForValue(i)+xScale.getPixelForValue(i+1))/2 : xScale.getPixelForValue(i)+((xScale.getPixelForValue(1)-xScale.getPixelForValue(0))/2);
        ctx.fillStyle = zoneColors[p.zone]||'transparent';
        ctx.fillRect(x0, top, x1-x0, bottom-top);
      });
    }
  };

  var datasets = [];

  // åŸºå‡†å›æ’¤èƒŒæ™¯æŸ±
  if(navDD.length){
    datasets.push({
      label:'åŸºå‡†å›æ’¤åŒºåŸŸ',data:navDD.map(function(v){return v?999:0}),
      type:'bar',backgroundColor:'rgba(239,68,68,0.08)',borderWidth:0,
      barPercentage:1.0,categoryPercentage:1.0,yAxisID:'yHidden',order:10
    });
  }

  // äº§å“å‡€å€¼ï¼ˆå·¦è½´ï¼‰
  if(fundNav){
    datasets.push({
      label:fundLabel,data:fundNav.map(function(v){return ((v-1)*100).toFixed(2)*1}),
      borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.06)',
      fill:true,borderWidth:2,pointRadius:0,tension:.3,yAxisID:'y'
    });
  }

  // åŸºå‡†å‡€å€¼ï¼ˆå·¦è½´ï¼‰
  if(indexNav){
    datasets.push({
      label:benchLabel,data:indexNav.map(function(v){return ((v-1)*100).toFixed(2)*1}),
      borderColor:'#94a3b8',borderDash:[5,3],
      borderWidth:1.5,pointRadius:0,tension:.3,yAxisID:'y'
    });
  }

  // ç´¯è®¡è¶…é¢ï¼ˆå³è½´ï¼‰â€” å¸¦zoneé¢œè‰²ç‚¹
  datasets.push({
    label:'ç´¯è®¡è¶…é¢(%)',data:exData,
    borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.08)',
    fill:true,borderWidth:2.5,pointRadius:4,pointHoverRadius:7,
    pointBackgroundColor:pts.map(function(p){
      return p.zone==='bad'?'#ef4444':p.zone==='weak'?'#f59e0b':p.zone==='good'?'#10b981':'#f59e0b';
    }),
    pointBorderColor:'#fff',pointBorderWidth:1.5,tension:0.15,yAxisID:'y1'
  });

  new Chart(document.getElementById('chartExcess'),{
    type:'line',
    data:{labels:labels,datasets:datasets},
    plugins:[bgPlugin],
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{position:'bottom',labels:{boxWidth:10,font:{size:10},padding:12,
          filter:function(item){return item.text!=='åŸºå‡†å›æ’¤åŒºåŸŸ'}}},
        tooltip:{enabled:false,external:function(context){
          var tt=document.getElementById('excess-tooltip');
          if(context.tooltip.opacity===0){tt.style.display='none';return;}
          var idx=context.tooltip.dataPoints[0].dataIndex;
          var p=pts[idx];
          var e=p.env||{};

          var html='<div style="font-weight:800;font-size:14px;margin-bottom:8px;color:#fff">';
          html+=p.date;
          if(fundNav) html+=' <span style="color:#c4b5fd">äº§å“ '+(((fundNav[idx]-1)*100)).toFixed(1)+'%</span>';
          html+=' <span style="color:'+(p.zone==='bad'?'#fca5a5':p.zone==='weak'?'#fde68a':'#6ee7b7')+'">è¶…é¢ '+(p.excess*100).toFixed(2)+'%</span>';
          if(idx>0) html+=' <span style="font-size:11px;color:#94a3b8">(å‘¨Î” '+(p.delta>0?'+':'')+(p.delta*100).toFixed(2)+'%)</span>';
          html+='</div>';

          var liq=e.liquidity;
          if(liq) html+='<div>ğŸ’§ æˆäº¤é¢ <b>'+liq.amount+'äº¿</b> '+liq.trend+' (CV='+liq.cv+')</div>';

          var disp=e.dispersion;
          if(disp) html+='<div>ğŸ“Š æˆªé¢æ³¢åŠ¨ç‡ <b>'+disp.cross_vol.toFixed(2)+'</b></div>';

          var sty=e.style;
          if(sty){
            html+='<div>ğŸ¯ HHI='+sty.hhi+' ä¸»å¯¼:'+sty.dominant+'('+sty.dominant_pct+'%)';
            if(Math.abs(sty.max_delta)>=1.5) html+=' <span style="color:#fca5a5">âš ï¸'+sty.max_mover+(sty.max_delta>0?'â†‘':'â†“')+Math.abs(sty.max_delta).toFixed(1)+'pp</span>';
            html+='</div>';
          }

          var bas=e.basis;
          if(bas){
            html+='<div>ğŸ”® IMåŸºå·® <b>'+bas.im+'%</b> (åˆ†ä½'+bas.pctile+'%)';
            if(bas.siphon) html+=' <span style="color:#fca5a5">ğŸš¨è™¹å¸! '+bas.siphon_note+'</span>';
            html+='</div>';
          }

          var fac=e.factors;
          if(fac){
            var facParts=[];
            for(var fn in fac){var v=fac[fn];if(Math.abs(v)>1) facParts.push(fn+(v>0?'â†‘':'â†“')+Math.abs(v).toFixed(1)+'%');}
            if(facParts.length) html+='<div>ğŸ“ˆ å› å­: '+facParts.join(', ')+'</div>';
          }

          tt.innerHTML=html;
          tt.style.display='block';
          var pos=context.chart.canvas.getBoundingClientRect();
          var left=context.tooltip.caretX+pos.left+12;
          var topY=context.tooltip.caretY+pos.top-30;
          var ttW=tt.offsetWidth||300;
          if(left+ttW>window.innerWidth-20) left=context.tooltip.caretX+pos.left-ttW-12;
          tt.style.position='fixed';
          tt.style.left=left+'px';
          tt.style.top=topY+'px';
        }}
      },
      scales:{
        x:{ticks:{maxTicksToShow:12,font:{size:10}},grid:{display:false}},
        y:{position:'left',ticks:{font:{size:10},callback:function(v){return v+'%'}},grid:{color:'rgba(0,0,0,.04)'},title:{display:true,text:'ç´¯è®¡æ”¶ç›Š%',font:{size:10},color:'#8b5cf6'}},
        y1:{position:'right',ticks:{font:{size:10},callback:function(v){return v+'%'},color:'#f59e0b'},grid:{drawOnChartArea:false},title:{display:true,text:'è¶…é¢%',font:{size:10},color:'#f59e0b'}},
        yHidden:{display:false}
      }
    }
  });
}).catch(function(e2){console.warn('excess_attribution load:',e2)});

}).catch(function(e){
  console.warn('quant_env_diag.json load failed:', e);
});

// â•â•â• åŸæœ‰å›¾è¡¨ â•â•â•
var base=location.href.replace(/[^/]*$/,'');if(!base.endsWith('/'))base+='/';var jsonUrl=base+'quant_stock_data.json';
fetch(jsonUrl).then(function(r){return r.json()}).then(function(QS){
  function fmtDate(d){return d.slice(0,4)+'-'+d.slice(4,6)+'-'+d.slice(6,8)}
  function ma(arr,n){return arr.map(function(v,i){if(i<n-1)return null;var s=0;for(var j=i-n+1;j<=i;j++)s+=arr[j];return s/n})}
  function val(v){return v==null?null:v}

  var lastDate=QS.total_amount[QS.total_amount.length-1].date;
  document.getElementById('dateLabel').innerHTML='ğŸ“Š å®½åŸºé‡åŒ–è‚¡ç¥¨ Â· æ•°æ®æˆªè‡³ <b>'+fmtDate(lastDate)+'</b>';

  var baseScales={x:{ticks:{maxTicksToShow:12,font:{size:10}}}};

  // å›¾1: å…¨å¸‚åœºæˆäº¤é¢
  var d1=QS.total_amount;
  var lab1=d1.map(function(r){return fmtDate(r.date)});
  var vals1=d1.map(function(r){return r.amount_yi});
  new Chart(document.getElementById('chartAmount'),{
    type:'line',
    data:{labels:lab1,datasets:[
      {label:'å…¨Aæˆäº¤é¢(äº¿)',data:vals1,borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,0.08)',fill:true,borderWidth:1.5,pointRadius:0,tension:0.1},
      {label:'MA20',data:ma(vals1,20),borderColor:'#f39c12',borderWidth:1.5,borderDash:[4,3],pointRadius:0,tension:0.1}
    ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
      scales:{x:baseScales.x,y:{ticks:{callback:function(v){return v>=10000?(v/10000).toFixed(1)+'ä¸‡äº¿':v+'äº¿'}}}}}
  });

  // å›¾2: å®½åŸºæˆäº¤é¢å æ¯”
  var d2=QS.index_share;
  var lab2=d2.map(function(r){return fmtDate(r.date)});
  var colors2=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6'];
  var names2=['æ²ªæ·±300','ä¸­è¯500','ä¸­è¯1000','ä¸­è¯2000','ç§‘åˆ›+åˆ›ä¸šæ¿'];
  new Chart(document.getElementById('chartShare'),{
    type:'line',
    data:{labels:lab2,datasets:names2.map(function(n,i){return{
      label:n,data:d2.map(function(r){return val(r[n])}),
      borderColor:colors2[i],borderWidth:1.5,pointRadius:0,tension:0.1,fill:false
    }})},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
      scales:{x:baseScales.x,y:{ticks:{callback:function(v){return v+'%'}},min:0}}}
  });

  // å›¾3: å¹´åŒ–åŸºå·®
  var d3=QS.basis;
  var lab3=d3.map(function(r){return fmtDate(r.date)});
  var bColors={IF:'#e74c3c',IC:'#3498db',IM:'#2ecc71'};
  var bNames={IF:'æ²ªæ·±300',IC:'ä¸­è¯500',IM:'ä¸­è¯1000'};
  new Chart(document.getElementById('chartBasis'),{
    type:'line',
    data:{labels:lab3,datasets:['IF','IC','IM'].map(function(k){return{
      label:k+'('+bNames[k]+')',data:d3.map(function(r){return val(r[k])}),
      borderColor:bColors[k],borderWidth:1.5,pointRadius:0,tension:0.1,fill:false
    }})},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
      scales:{x:baseScales.x,y:{ticks:{callback:function(v){return v+'%'}}}}}
  });

  // å›¾4: å› å­è¶…é¢æ”¶ç›Š
  var d4=QS.factor;
  var fNames=QS.factor_names;
  var lab4=d4.map(function(r){return fmtDate(r.date)});
  var colors4=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6'];
  new Chart(document.getElementById('chartFactor'),{
    type:'line',
    data:{labels:lab4,datasets:fNames.map(function(n,i){return{
      label:n,data:d4.map(function(r){return val(r[n])}),
      borderColor:colors4[i],borderWidth:1.5,pointRadius:0,tension:0.1,fill:false
    }})},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
      scales:{x:baseScales.x,y:{ticks:{callback:function(v){return v.toFixed(2)}}}}}
  });

}).catch(function(e){document.body.innerHTML='<p style="color:red;padding:40px">æ•°æ®åŠ è½½å¤±è´¥: '+e.message+'</p>'});
})();
function doRefresh(){var b=document.getElementById('refreshBtn');b.classList.add('loading');b.innerHTML='â³ åˆ·æ–°ä¸­...';location.reload();}
</script>
</body></html>
