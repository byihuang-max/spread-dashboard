<!DOCTYPE html>
<html lang="zh"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æœŸæƒå¼‚å¸¸å€¼ç›‘æ§</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,'PingFang SC','Helvetica Neue',sans-serif;background:#f5f6f8;color:#2d3142;padding:20px;font-size:14px}
h2{font-size:16px;font-weight:700;margin-bottom:12px;color:#1e2433}
.section{margin-bottom:28px}

/* æ ‡çš„é€‰æ‹©å™¨ */
.und-tabs{display:flex;gap:8px;margin-bottom:20px}
.und-tab{padding:8px 18px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;background:#fff;border:1px solid #e8eaef;color:#6b7280;transition:all .15s}
.und-tab.active{background:#1e2433;color:#fff;border-color:#1e2433}
.und-tab:hover:not(.active){border-color:#6366f1;color:#6366f1}

/* æ‘˜è¦å¡ç‰‡ */
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
.s-card{background:#fff;border-radius:10px;padding:14px;border:1px solid #e8eaef;text-align:center}
.s-card .s-label{font-size:11px;color:#8b92a5;font-weight:600;margin-bottom:6px}
.s-card .s-value{font-size:22px;font-weight:800}
.s-card .s-sub{font-size:11px;color:#8b92a5;margin-top:4px}

/* å›¾è¡¨ */
.chart-box{background:#fff;border-radius:10px;padding:16px;border:1px solid #e8eaef;margin-bottom:16px}
.chart-box h3{font-size:13px;font-weight:700;color:#374151;margin-bottom:12px}
.chart-wrap{position:relative;height:260px}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:768px){.chart-row{grid-template-columns:1fr}}

/* å¼‚å¸¸è¡¨æ ¼ */
.anomaly-table{width:100%;border-collapse:collapse;font-size:12px}
.anomaly-table th{background:#f9fafb;padding:8px 10px;text-align:left;font-weight:700;color:#374151;border-bottom:2px solid #e5e7eb}
.anomaly-table td{padding:8px 10px;border-bottom:1px solid #f3f4f6}
.anomaly-table tr:hover{background:#f9fafb}
.tag-oi{background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700}
.tag-iv{background:#ede9fe;color:#5b21b6;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700}

/* IVåˆ†ä½æ¡ */
.pct-bar{height:8px;border-radius:4px;background:#e5e7eb;position:relative;margin-top:4px}
.pct-fill{height:100%;border-radius:4px;position:absolute;left:0;top:0}

.loading{text-align:center;padding:60px;color:#8b92a5}
</style>
</head>
<body>
<div class="loading" id="loadingMsg">åŠ è½½ä¸­...</div>
<div id="app" style="display:none">

<div class="und-tabs" id="undTabs"></div>
<div class="summary-cards" id="summaryCards"></div>

<div class="chart-row section">
  <div class="chart-box">
    <h3>ğŸ“ IVæœŸé™ç»“æ„ï¼ˆå¹³å€¼ï¼‰</h3>
    <div class="chart-wrap"><canvas id="termChart"></canvas></div>
  </div>
  <div class="chart-box">
    <h3>ğŸ“Š PCRï¼ˆæŒä»“é‡ & æˆäº¤é‡ï¼‰</h3>
    <div class="chart-wrap"><canvas id="pcrChart"></canvas></div>
  </div>
</div>

<div class="chart-row section">
  <div class="chart-box">
    <h3>ğŸ“ˆ ATMéšå«æ³¢åŠ¨ç‡ï¼ˆè¿‘æœˆï¼‰+ 20æ—¥åˆ†ä½</h3>
    <div class="chart-wrap"><canvas id="ivChart"></canvas></div>
  </div>
  <div class="chart-box">
    <h3>ğŸ“Š æŒä»“é‡æŒ‰è¡Œæƒä»·åˆ†å¸ƒï¼ˆè¿‘æœˆï¼‰</h3>
    <div class="chart-wrap"><canvas id="oiChart"></canvas></div>
  </div>
</div>

<div class="section">
  <h2>âš ï¸ å¼‚å¸¸ä¿¡å·</h2>
  <table class="anomaly-table" id="anomalyTable">
    <thead><tr><th>ç±»å‹</th><th>æ ‡ç­¾</th><th>è¯¦æƒ…</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- æ³¨é‡Š -->
<div style="margin-top:20px;padding:20px;background:#fff;border-radius:10px;border:1px solid #e8eaef;font-size:12px;color:#6b7280;line-height:1.8">
  <div style="font-weight:700;color:#374151;margin-bottom:8px;font-size:13px">ğŸ“– æŒ‡æ ‡è¯´æ˜</div>
  <div><b>IVï¼ˆéšå«æ³¢åŠ¨ç‡ï¼‰ï¼š</b>é€šè¿‡BSæ¨¡å‹ä»æœŸæƒç»“ç®—ä»·åæ¨ï¼Œä»£è¡¨å¸‚åœºå¯¹æœªæ¥æ³¢åŠ¨çš„é¢„æœŸã€‚IVä¸Šå‡=å¸‚åœºææ…Œ/ä¸ç¡®å®šæ€§å¢å¤§ã€‚</div>
  <div><b>IV 20æ—¥åˆ†ä½ï¼š</b>å½“å‰IVåœ¨è¿‡å»20ä¸ªäº¤æ˜“æ—¥ä¸­çš„å†å²ç™¾åˆ†ä½ã€‚>80%=æ³¢åŠ¨ç‡åé«˜ï¼ˆå¯¹å†²æˆæœ¬è´µï¼‰ï¼Œ<20%=æ³¢åŠ¨ç‡åä½ï¼ˆä¹°ä¿é™©ä¾¿å®œï¼‰ã€‚</div>
  <div><b>IVæœŸé™ç»“æ„ï¼š</b>ä¸åŒåˆ°æœŸæœˆçš„å¹³å€¼IVæ›²çº¿ã€‚æ­£å¸¸è¿œæœˆ>è¿‘æœˆï¼ˆæœŸé™æº¢ä»·ï¼‰ï¼Œè¿‘æœˆ>è¿œæœˆ=å€’æŒ‚ï¼ˆå¸‚åœºé¢„æœŸçŸ­æœŸæœ‰å¤§äº‹ï¼‰ã€‚</div>
  <div><b>PCRï¼ˆPut-Call Ratioï¼‰ï¼š</b>è®¤æ²½/è®¤è´­æŒä»“é‡ä¹‹æ¯”ã€‚PCRä¸Šå‡=çœ‹ç©ºæƒ…ç»ªå¢åŠ ã€‚æç«¯é«˜å€¼å¯èƒ½æ˜¯åå‘æŒ‡æ ‡ï¼ˆè¿‡åº¦ææ…Œååå¼¹ï¼‰ã€‚</div>
  <div><b>OIåˆ†å¸ƒï¼š</b>æŒ‰è¡Œæƒä»·çš„æŒä»“é‡åˆ†å¸ƒã€‚Call OI é›†ä¸­å¤„=æ½œåœ¨å‹åŠ›ä½ï¼ŒPut OI é›†ä¸­å¤„=æ½œåœ¨æ”¯æ’‘ä½ã€‚</div>
  <div><b>OIæ¿€å¢ï¼š</b>æŸåˆçº¦æŒä»“é‡è¶…è¿‡å‰5æ—¥å‡å€¼2å€ä»¥ä¸Šï¼Œè¯´æ˜å¤§èµ„é‡‘åœ¨è¯¥è¡Œæƒä»·å»ºä»“ã€‚æ·±åº¦è™šå€¼Put OIæ¿€å¢=æœ‰äººä¹°å°¾éƒ¨ä¿é™©ã€‚</div>
  <div><b>IVå¼‚å¸¸ï¼š</b>å½“æ—¥IVåç¦»å‰5æ—¥å‡å€¼è¶…è¿‡2ä¸ªæ ‡å‡†å·®ï¼Œæ ‡è®°ä¸ºæ³¢åŠ¨ç‡å¼‚å¸¸æ”¾å¤§/ç¼©å°ã€‚</div>
  <div style="margin-top:8px;color:#9ca3af;font-size:11px">æ•°æ®æ¥æºï¼šTushareï¼ˆopt_basic + opt_daily + fund_dailyï¼‰ï¼ŒIVé€šè¿‡æ¬§å¼BSæ¨¡å‹åç®—ï¼Œæ— é£é™©åˆ©ç‡1.5%</div>
</div>

</div>

<script>
var DATA, charts={};
function loadData(){
  fetch('option_sentiment.json?t='+Date.now())
    .then(function(r){return r.json()})
    .then(function(d){DATA=d;renderTabs();selectUnd(0)})
    .catch(function(e){document.getElementById('loadingMsg').textContent='åŠ è½½å¤±è´¥: '+e.message})
}

function renderTabs(){
  document.getElementById('loadingMsg').style.display='none';
  document.getElementById('app').style.display='';
  var html='';
  (DATA.underlyings||[]).forEach(function(u,i){
    html+='<div class="und-tab'+(i===0?' active':'')+'" onclick="selectUnd('+i+')">'+u.name+'</div>';
  });
  document.getElementById('undTabs').innerHTML=html;
}

function selectUnd(idx){
  var tabs=document.querySelectorAll('.und-tab');
  tabs.forEach(function(t,i){t.classList.toggle('active',i===idx)});
  var u=DATA.underlyings[idx];
  if(!u)return;
  renderSummary(u);
  renderTermChart(u);
  renderPCRChart(u);
  renderIVChart(u);
  renderOIChart(u);
  renderAnomalies(u);
}

function renderSummary(u){
  var s=u.summary||{};
  var ivColor=s.iv_percentile>80?'#dc2626':s.iv_percentile<20?'#16a34a':'#2563eb';
  var pctColor=s.iv_percentile>80?'#dc2626':s.iv_percentile<20?'#16a34a':'#6366f1';
  var pctBg=s.iv_percentile>80?'#fca5a5':s.iv_percentile<20?'#86efac':'#a5b4fc';
  var html='';
  html+='<div class="s-card"><div class="s-label">ç°ä»·</div><div class="s-value">'+s.spot.toFixed(3)+'</div></div>';
  html+='<div class="s-card"><div class="s-label">ATM IV</div><div class="s-value" style="color:'+ivColor+'">'+s.atm_iv.toFixed(1)+'%</div></div>';
  html+='<div class="s-card"><div class="s-label">IV 20æ—¥åˆ†ä½</div><div class="s-value" style="color:'+pctColor+'">'+s.iv_percentile.toFixed(0)+'%</div><div class="pct-bar"><div class="pct-fill" style="width:'+s.iv_percentile+'%;background:'+pctBg+'"></div></div></div>';
  html+='<div class="s-card"><div class="s-label">PCR (OI)</div><div class="s-value">'+s.pcr_oi.toFixed(3)+'</div></div>';
  html+='<div class="s-card"><div class="s-label">PCR (Vol)</div><div class="s-value">'+s.pcr_vol.toFixed(3)+'</div></div>';
  html+='<div class="s-card"><div class="s-label">å¼‚å¸¸ä¿¡å·</div><div class="s-value" style="color:'+(s.anomaly_count>0?'#dc2626':'#16a34a')+'">'+s.anomaly_count+'</div></div>';
  document.getElementById('summaryCards').innerHTML=html;
}

function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id]}}

function renderTermChart(u){
  destroyChart('termChart');
  var ts=u.term_structure||[];
  if(!ts.length)return;
  charts['termChart']=new Chart(document.getElementById('termChart'),{
    type:'line',
    data:{labels:ts.map(function(d){return d.maturity}),
      datasets:[{label:'IV %',data:ts.map(function(d){return d.iv}),
        borderColor:'#6366f1',backgroundColor:'#6366f118',fill:true,tension:0.3,borderWidth:2.5,pointRadius:5,pointBackgroundColor:'#6366f1'}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{y:{title:{display:true,text:'IV %',font:{size:11}},grid:{color:'#f0f0f0'}},
              x:{title:{display:true,text:'åˆ°æœŸæœˆ',font:{size:11}}}}}
  });
}

function renderPCRChart(u){
  destroyChart('pcrChart');
  var pcr=u.pcr_history||[];
  if(!pcr.length)return;
  charts['pcrChart']=new Chart(document.getElementById('pcrChart'),{
    type:'line',
    data:{labels:pcr.map(function(d){return d.date}),
      datasets:[
        {label:'PCR(OI)',data:pcr.map(function(d){return d.pcr_oi}),borderColor:'#dc2626',borderWidth:2,tension:0.3,pointRadius:0},
        {label:'PCR(Vol)',data:pcr.map(function(d){return d.pcr_vol}),borderColor:'#f59e0b',borderWidth:2,tension:0.3,pointRadius:0,borderDash:[4,4]}
      ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{font:{size:11}}}},
      scales:{y:{grid:{color:'#f0f0f0'}},x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:12,font:{size:10}}}}}
  });
}

function renderIVChart(u){
  destroyChart('ivChart');
  var iv=u.iv_history||[];
  if(!iv.length)return;
  charts['ivChart']=new Chart(document.getElementById('ivChart'),{
    type:'line',
    data:{labels:iv.map(function(d){return d.date}),
      datasets:[
        {label:'ATM IV %',data:iv.map(function(d){return d.iv}),borderColor:'#6366f1',borderWidth:2,tension:0.3,pointRadius:0,yAxisID:'y'},
        {label:'20æ—¥åˆ†ä½ %',data:iv.map(function(d){return d.percentile}),borderColor:'#10b981',borderWidth:2,tension:0.3,pointRadius:0,borderDash:[4,4],yAxisID:'y1'}
      ]},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{font:{size:11}}}},
      scales:{
        y:{position:'left',title:{display:true,text:'IV %',font:{size:10}},grid:{color:'#f0f0f0'}},
        y1:{position:'right',title:{display:true,text:'åˆ†ä½ %',font:{size:10}},min:0,max:100,grid:{display:false}},
        x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:12,font:{size:10}}}
      }}
  });
}

function renderOIChart(u){
  destroyChart('oiChart');
  var oi=u.oi_distribution||[];
  if(!oi.length)return;
  var spot=u.summary.spot;
  // åªæ˜¾ç¤ºç°ä»·é™„è¿‘çš„è¡Œæƒä»·
  var filtered=oi.filter(function(d){return d.strike>=spot*0.9&&d.strike<=spot*1.1});
  if(!filtered.length) filtered=oi;
  charts['oiChart']=new Chart(document.getElementById('oiChart'),{
    type:'bar',
    data:{labels:filtered.map(function(d){return d.strike.toFixed(2)}),
      datasets:[
        {label:'Call OI',data:filtered.map(function(d){return d.call_oi}),backgroundColor:'#ef444488',borderColor:'#ef4444',borderWidth:1},
        {label:'Put OI',data:filtered.map(function(d){return -d.put_oi}),backgroundColor:'#22c55e88',borderColor:'#22c55e',borderWidth:1}
      ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{font:{size:11}}},
        tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': '+Math.abs(ctx.raw).toLocaleString()}}}},
      scales:{x:{ticks:{font:{size:9},maxRotation:45}},y:{grid:{color:'#f0f0f0'},
        ticks:{callback:function(v){return Math.abs(v).toLocaleString()}}}}}
  });
}

function renderAnomalies(u){
  var tbody=document.querySelector('#anomalyTable tbody');
  var anomalies=u.anomalies||[];
  if(!anomalies.length){
    tbody.innerHTML='<tr><td colspan="3" style="text-align:center;color:#8b92a5;padding:20px">å½“å‰æ— å¼‚å¸¸ä¿¡å· âœ…</td></tr>';
    return;
  }
  var html='';
  anomalies.forEach(function(a){
    var tag=a.type==='oi_surge'?'<span class="tag-oi">OIæ¿€å¢</span>':'<span class="tag-iv">IVå¼‚å¸¸</span>';
    html+='<tr><td>'+tag+'</td><td style="font-weight:700">'+a.label+'</td><td>'+a.detail+'</td></tr>';
  });
  tbody.innerHTML=html;
}

loadData();
</script>
</body></html>
