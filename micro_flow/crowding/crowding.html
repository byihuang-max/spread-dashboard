<!DOCTYPE html>
<html lang="zh"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>èµ„é‡‘æ‹¥æŒ¤åº¦ç›‘æ§</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,'PingFang SC','Helvetica Neue',sans-serif;background:#f5f6f8;color:#2d3142;padding:20px;font-size:14px}
h2{font-size:16px;font-weight:700;margin-bottom:16px;color:#1e2433}
.section{margin-bottom:24px}

.signal-bar{background:linear-gradient(135deg,#1e2433,#2a3350);border-radius:12px;padding:16px 20px;color:#e2e6ed;display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:20px}
.signal-main{font-size:20px;font-weight:800;letter-spacing:1px}
.signal-tags{display:flex;gap:8px;flex-wrap:wrap}
.signal-tag{background:rgba(255,255,255,0.1);padding:4px 12px;border-radius:20px;font-size:12px;color:#b8bfce}
.signal-tag.warn{background:rgba(245,158,11,0.25);color:#fbbf24}
.signal-tag.good{background:rgba(34,197,94,0.2);color:#4ade80}
.signal-tag.risk{background:rgba(239,68,68,0.2);color:#f87171}

.flow-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.flow-card{background:#fff;border-radius:10px;padding:16px;border:1px solid #e8eaef}
.flow-card .name{font-size:12px;color:#8b92a5;margin-bottom:8px;font-weight:600}
.flow-card .value{font-size:22px;font-weight:800;margin-bottom:4px}
.flow-card .dir{font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px;display:inline-block}
.flow-card .dir.inflow{background:#dcfce7;color:#16a34a}
.flow-card .dir.outflow{background:#fee2e2;color:#dc2626}
.flow-card .ma-info{font-size:11px;color:#8b92a5;margin-top:6px}

.chart-box{background:#fff;border-radius:10px;padding:16px;border:1px solid #e8eaef;margin-bottom:16px}
.chart-box h3{font-size:13px;font-weight:700;color:#374151;margin-bottom:12px}
.chart-wrap{position:relative;height:280px}

/* è¡Œä¸šçƒ­åŠ›å›¾ - å¢å¼ºç‰ˆ */
.ind-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:8px}
.ind-cell{padding:12px 10px;border-radius:10px;text-align:center;font-size:11px;line-height:1.5;transition:transform .15s;position:relative;cursor:default}
.ind-cell:hover{transform:scale(1.04);z-index:2;box-shadow:0 4px 16px rgba(0,0,0,0.15)}
.ind-cell .ind-name{font-weight:800;font-size:13px;margin-bottom:3px}
.ind-cell .ind-pct{font-size:16px;font-weight:800;margin-bottom:4px}
.ind-cell .ind-tags{display:flex;gap:4px;justify-content:center;flex-wrap:wrap;margin-top:4px}
.ind-cell .ind-tag{font-size:9px;padding:1px 6px;border-radius:10px;background:rgba(255,255,255,0.3);white-space:nowrap}
.ind-cell .ind-signal{font-size:10px;font-weight:700;margin-top:4px;padding:2px 6px;border-radius:6px;background:rgba(0,0,0,0.15);display:inline-block}
.ind-cell .ind-crowd{font-size:10px;color:rgba(255,255,255,0.7);margin-top:2px}

.margin-box{background:#fff;border-radius:10px;padding:16px;border:1px solid #e8eaef}
.margin-box h3{font-size:13px;font-weight:700;color:#374151;margin-bottom:12px}

.loading{text-align:center;padding:60px;color:#8b92a5;font-size:14px}

/* å›¾ä¾‹ */
.legend{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;font-size:11px;color:#6b7280}
.legend-item{display:flex;align-items:center;gap:4px}
.legend-dot{width:10px;height:10px;border-radius:3px;display:inline-block}
</style>
</head>
<body>
<div class="loading" id="loadingMsg">åŠ è½½ä¸­...</div>
<div id="app" style="display:none">

<div class="signal-bar">
  <div class="signal-main" id="consensusLabel">--</div>
  <div class="signal-tags" id="signalTags"></div>
  <div style="margin-left:auto;font-size:11px;color:#7c8598" id="updateTime"></div>
</div>

<div class="flow-cards" id="flowCards"></div>

<div class="chart-box section">
  <h3>ğŸ“Š ä¸‰è·¯èµ„é‡‘æ¯æ—¥å‡€æµå…¥ï¼ˆ60æ—¥ï¼‰</h3>
  <div class="chart-wrap"><canvas id="dailyChart"></canvas></div>
</div>

<div class="chart-box section">
  <h3>ğŸ“ˆ 20æ—¥æ»šåŠ¨ç´¯è®¡å‡€æµå…¥</h3>
  <div class="chart-wrap"><canvas id="cumChart"></canvas></div>
</div>

<!-- è¡Œä¸šä¸‰ç»´çƒ­åŠ›å›¾ -->
<div class="section">
  <h2>ğŸ”¥ ç”³ä¸‡è¡Œä¸šæ‹¥æŒ¤åº¦ï¼ˆè¿‘5æ—¥ï¼‰</h2>
  <div class="legend">
    <div class="legend-item"><span class="legend-dot" style="background:#16a34a"></span> æ¶¨ / ç»¿æ·±=æ¶¨å¤š</div>
    <div class="legend-item"><span class="legend-dot" style="background:#dc2626"></span> è·Œ / çº¢æ·±=è·Œå¤š</div>
    <div class="legend-item">ğŸ”¥ æ‹¥æŒ¤(é‡/MA20&gt;1.5)</div>
    <div class="legend-item">â„ï¸ å†·æ¸…(é‡/MA20&lt;0.7)</div>
    <div class="legend-item">â–² ETFæµå…¥</div>
    <div class="legend-item">â–¼ ETFæµå‡º</div>
  </div>
  <div class="ind-grid" id="indGrid"></div>
</div>

<div class="margin-box section">
  <h3>ğŸ’³ ä¸¤èä½™é¢è¶‹åŠ¿ï¼ˆ60æ—¥ï¼‰</h3>
  <div class="chart-wrap"><canvas id="marginChart"></canvas></div>
</div>

</div>

<script>
var DATA;
function loadData(){
  fetch('crowding.json?t='+Date.now())
    .then(function(r){return r.json()})
    .then(function(d){DATA=d;render()})
    .catch(function(e){document.getElementById('loadingMsg').textContent='åŠ è½½å¤±è´¥: '+e.message})
}

function render(){
  document.getElementById('loadingMsg').style.display='none';
  document.getElementById('app').style.display='';

  // ä¿¡å·æ 
  var sig=DATA.crowding_signal||{};
  document.getElementById('consensusLabel').textContent=sig.consensus||'--';
  var tags=sig.signals||[];
  document.getElementById('signalTags').innerHTML=tags.map(function(t){
    var cls='signal-tag';
    if(t.indexOf('âš ï¸')>=0||t.indexOf('è¿½é«˜')>=0) cls+=' risk';
    else if(t.indexOf('âœ…')>=0||t.indexOf('ç¡®è®¤')>=0||t.indexOf('ğŸŸ¢')>=0) cls+=' good';
    else if(t.indexOf('ğŸ”´')>=0) cls+=' risk';
    return '<span class="'+cls+'">'+t+'</span>'
  }).join('');
  document.getElementById('updateTime').textContent='æ›´æ–°: '+(DATA.update_time||'');

  // ä¸‰è·¯å¡ç‰‡
  var flows=DATA.three_flows||{};
  var details=flows.details||{};
  var html='';
  ['north_net','etf_share_chg','margin_chg'].forEach(function(k){
    var d=details[k];
    if(!d)return;
    var cls=d.direction==='inflow'?'inflow':'outflow';
    var dirText=d.direction==='inflow'?'â–² æµå…¥':'â–¼ æµå‡º';
    html+='<div class="flow-card">'+
      '<div class="name">'+d.name+'</div>'+
      '<div class="value">'+d.latest+'</div>'+
      '<div class="dir '+cls+'">'+dirText+'</div>'+
      '<div class="ma-info">MA5: '+d.ma5+' | MA20: '+d.ma20+'</div></div>';
  });
  document.getElementById('flowCards').innerHTML=html;

  renderDailyChart();
  renderCumChart();
  renderIndustryGrid();
  renderMarginChart();
}

function renderDailyChart(){
  var chart=DATA.direction_chart||[];
  var labels=chart.map(function(d){return d.date});
  var datasets=[];
  var colors={north_net:'#6366f1',etf_share_chg:'#f59e0b',margin_chg:'#10b981'};
  var names={north_net:'åŒ—å‘(äº¿)',etf_share_chg:'ETFä»½é¢å˜åŒ–(ä¸‡ä»½)',margin_chg:'ä¸¤èå˜åŒ–(äº¿)'};
  ['north_net','etf_share_chg','margin_chg'].forEach(function(k){
    if(!chart.some(function(d){return d[k]!=null}))return;
    datasets.push({label:names[k],data:chart.map(function(d){return d[k]}),
      backgroundColor:colors[k]+'88',borderColor:colors[k],borderWidth:1,barPercentage:0.6});
  });
  new Chart(document.getElementById('dailyChart'),{type:'bar',
    data:{labels:labels,datasets:datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{font:{size:11}}}},
      scales:{x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:15,font:{size:10}}},y:{grid:{color:'#f0f0f0'}}}}
  });
}

function renderCumChart(){
  var rolling=DATA.rolling_cum||[];
  if(!rolling.length)return;
  var colors=['#6366f1','#f59e0b','#10b981'];
  var datasets=rolling.map(function(s,i){
    return{label:s.name+'(20æ—¥ç´¯è®¡)',data:s.data.map(function(d){return d.value}),
      borderColor:colors[i%3],backgroundColor:colors[i%3]+'18',fill:true,tension:0.3,borderWidth:2,pointRadius:0}
  });
  new Chart(document.getElementById('cumChart'),{type:'line',
    data:{labels:rolling[0].data.map(function(d){return d.date}),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'top',labels:{font:{size:11}}}},
      scales:{x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:15,font:{size:10}}},y:{grid:{color:'#f0f0f0'}}}}
  });
}

function renderIndustryGrid(){
  var inds=DATA.industry_heatmap||[];
  if(!inds.length){document.getElementById('indGrid').innerHTML='<div style="color:#8b92a5;padding:20px">æš‚æ— æ•°æ®</div>';return}

  var maxPct=Math.max.apply(null,inds.map(function(d){return Math.abs(d.pct_5d)}))||1;
  var html='';
  inds.forEach(function(d){
    var ratio=d.pct_5d/maxPct;
    var bg,fg;
    if(d.pct_5d>=0){
      var alpha=Math.min(Math.abs(ratio)*0.65+0.15,0.85);
      bg='rgba(22,163,106,'+alpha+')';
      fg=alpha>0.4?'#fff':'#16a34a';
    }else{
      var alpha=Math.min(Math.abs(ratio)*0.65+0.15,0.85);
      bg='rgba(220,38,38,'+alpha+')';
      fg=alpha>0.4?'#fff':'#dc2626';
    }

    var tagsHtml='';
    if(d.tags&&d.tags.length){
      tagsHtml='<div class="ind-tags">'+d.tags.map(function(t){return'<span class="ind-tag">'+t+'</span>'}).join('')+'</div>';
    }

    var signalHtml='';
    if(d.signal){
      signalHtml='<div class="ind-signal">'+d.signal+'</div>';
    }

    var crowdText='é‡æ¯”: '+d.crowding_ratio.toFixed(2);

    html+='<div class="ind-cell" style="background:'+bg+';color:'+fg+'" title="'+d.name+' | 5æ—¥æ¶¨è·Œ:'+d.pct_5d+'% | é‡/MA20:'+d.crowding_ratio+'">'+
      '<div class="ind-name">'+d.name+'</div>'+
      '<div class="ind-pct">'+(d.pct_5d>=0?'+':'')+d.pct_5d.toFixed(2)+'%</div>'+
      '<div class="ind-crowd">'+crowdText+'</div>'+
      tagsHtml+signalHtml+
    '</div>';
  });
  document.getElementById('indGrid').innerHTML=html;
}

function renderMarginChart(){
  var mt=DATA.margin_trend||[];
  if(!mt.length)return;
  new Chart(document.getElementById('marginChart'),{type:'line',
    data:{labels:mt.map(function(d){return d.date}),
      datasets:[{label:'ä¸¤èä½™é¢(äº¿)',data:mt.map(function(d){return d.balance}),
        borderColor:'#8b5cf6',backgroundColor:'#8b5cf618',fill:true,tension:0.3,borderWidth:2,pointRadius:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:15,font:{size:10}}},y:{grid:{color:'#f0f0f0'}}}}
  });
}

loadData();
</script>
</body></html>
